"""ğŸŒ² Forest Adventure Game - Step 6 (Abilities with byllm + Gemini AI)"""
import random;
import os;
import from byllm.llm { Model }

glob llm = Model(
    model_name="gemini/gemini-2.5-flash",
    verbose=False
);

"""Generate atmospheric description for location"""
def generate_atmosphere(location_name: str, description: str) -> str by llm();

"""Generate strategic hint for player"""
def generate_hint(moves: int, items: str, location: str) -> str by llm();

"""Analyze player's performance"""
def analyze_performance(won: bool, moves: int, items: str, score: int) -> str by llm();

"""Generate item discovery message"""
def generate_item_message(item_name: str) -> str by llm();

walker ForestExplorer {
    has player_choice: str = "";
    has moves_taken: int = 0;
    has items_collected: list = [];
    has path_history: list = [];
    has game_over: bool = False;
    has won: bool = False;
    has visited_locations: list = [];
    
    can start with `root entry;
    can explore_location with location entry;
    can show_final_results with `root entry;
}

node location {
    has name: str = "Forest Entrance";
    has description: str = "You stand at the entrance.";
    has is_goal: bool = False;
    has is_danger: bool = False;
    has item: str = "";
    has danger_level: int = 0;
}

with entry:__main__ {
    root spawn ForestExplorer();
}

impl ForestExplorer.start {
    print("\n" + "="*60);
    print("ğŸŒ² FOREST ADVENTURE - AI ENHANCED ğŸŒ²".center(60));
    print("="*60);
    print("\nğŸ® STEP 6 VERSION - Abilities with byllm + Gemini!");
    print("\nğŸ“– Explore the enchanted forest.");
    print("   Choose LEFT or RIGHT at each location.");
    print("   Collect items to protect yourself!");
    print(f"   You have 15 moves.\n");
    print("="*60);
    
    input("\nâ¤ Press ENTER to begin...");
    
    entrance = root ++> location(
        name="ğŸŒ² Enchanted Forest Entrance",
        description="Magical energy tingles in the air. Two paths lie ahead.",
        is_goal=False,
        is_danger=False,
        item="",
        danger_level=0
    );
    
    visit entrance;
}

impl ForestExplorer.explore_location {
    print("\n" + "="*60);
    print(f"ğŸ“ {here.name}");
    print("-"*60);
    
    print("âœ¨ Observing the environment...");
    ai_atmosphere = generate_atmosphere(here.name, here.description);
    print(f"\nğŸŒŸ {ai_atmosphere}");
    
    if here.danger_level > 0 {
        print(f"\nâš ï¸  Danger: {'ğŸ”¥' * here.danger_level}");
    }
    
    print(f"\nâ±ï¸  Moves: {self.moves_taken}/15");
    print("="*60);
    
    if here.item and here.item not in self.items_collected {
        print(f"\nâœ¨ DISCOVERY! You found: {here.item}!");
        self.items_collected.append(here.item);
        
        print("ğŸ” Examining the item...");
        item_msg = generate_item_message(here.item);
        print(f"ğŸ’¬ {item_msg}");
    }
    
    if len(self.items_collected) > 0 {
        print(f"\nğŸ’ Your Items: {' | '.join(self.items_collected)}");
    }
    
    if here.is_danger {
        print("\n" + "ğŸ’€"*20);
        print("âš ï¸  DANGER DETECTED! âš ï¸");
        
        can_escape = False;
        used_item = "";
        
        if "Fairy Blessing" in self.items_collected {
            print("âœ¨ Your Fairy Blessing protects you!");
            can_escape = True;
            used_item = "Fairy Blessing";
        } elif "Magic Amulet" in self.items_collected {
            print("ğŸ”® The Magic Amulet shields you!");
            can_escape = True;
            used_item = "Magic Amulet";
        } elif "Crystal Water" in self.items_collected {
            print("ğŸ’§ The Crystal Water heals you!");
            can_escape = True;
            used_item = "Crystal Water";
        } elif "Echo Stone" in self.items_collected {
            print("ğŸ¦‡ The Echo Stone confuses your enemies!");
            can_escape = True;
            used_item = "Echo Stone";
        } elif "Butterfly Wing" in self.items_collected {
            print("ğŸ¦‹ The Butterfly Wing lets you fly away!");
            can_escape = True;
            used_item = "Butterfly Wing";
        }
        
        if can_escape {
            print("ğŸ‰ You narrowly escaped!");
            self.items_collected.remove(used_item);
            print(f"ğŸ’” You used: {used_item}");
        } else {
            print("ğŸ’€ The danger is too great. Game over!");
            self.game_over = True;
        }
        
        print("ğŸ’€"*20 + "\n");
    }
    
    if here.is_goal and not self.game_over {
        print("\n" + "ğŸ‰"*20);
        print("ğŸ† VICTORY! ğŸ†");
        print(f"You discovered: {here.name}!");
        self.won = True;
        self.game_over = True;
        print("ğŸ‰"*20 + "\n");
    }
    
    if self.game_over {
        visit [-->](`?root);
    }
    
    if self.moves_taken >= 15 {
        print("\nâ° TIME'S UP! You ran out of moves.");
        self.game_over = True;
        visit [-->](`?root);
    }
    
    print("\n" + "-"*60);
    print("ğŸ¤” Choose your path:");
    print("   ğŸ‘ˆ [L/LEFT/1] Go LEFT");
    print("   ğŸ‘‰ [R/RIGHT/2] Go RIGHT");
    print("   ğŸ’¡ [H/HINT/?] Get AI Hint");
    print("   ğŸšª [Q/QUIT] Quit");
    print("-"*60);
    
    player_choice = input("\nâ¤ Your choice: ");
    self.player_choice = player_choice.strip().upper();
    
    if self.player_choice in ["Q", "QUIT", "EXIT", "END"] {
        print("\nğŸ‘‹ Thanks for exploring!");
        self.game_over = True;
        visit [-->](`?root);
    } elif self.player_choice in ["H", "HINT", "HELP", "?"] {
        print("\nğŸ”® Consulting the AI Guide...\n");
        items_str = ', '.join(self.items_collected) if len(self.items_collected) > 0 else "none";
        hint = generate_hint(self.moves_taken, items_str, here.name);
        print(f"\nğŸ’¡ AI GUIDE: {hint}\n");
        
        visit here;
    } elif self.player_choice in ["L", "LEFT", "<", "1"] {
        self.moves_taken += 1;
        self.path_history.append("LEFT");
        left_locs = [
            ("ğŸŒ‘ Shadow Grove", "Dark trees loom. Whispers echo.", False, False, 1, ""),
            ("ğŸ•·ï¸ Spider's Lair", "Giant webs block your path!", False, True, 3, ""),
            ("ğŸ„ Fairy Ring", "Glowing mushrooms dance!", False, False, 0, "Fairy Blessing"),
            ("ğŸ’ Dragon's Hoard", "Mountains of treasure!", True, False, 0, "Dragon Treasure"),
            ("ğŸ”® Mystic Altar", "An altar pulses with power.", False, False, 0, "Magic Amulet"),
            ("ğŸ¦‡ Bat Cave", "Hundreds of bats swirl around you!", False, False, 2, "Echo Stone"),
            ("ğŸŒ™ Moonlit Path", "Silver light guides your way.", False, False, 0, "Moon Crystal"),
            ("âš”ï¸ Ancient Ruins", "Crumbling stone structures remain.", False, True, 2, "")
        ];
        
        available_locs = [loc for loc in left_locs if loc[0] not in self.visited_locations];
        if len(available_locs) == 0 {
            available_locs = left_locs;
            self.visited_locations = [];
        }
        
        chosen = random.choice(available_locs);
        self.visited_locations.append(chosen[0]);
        next_loc = here ++> location(name=chosen[0], description=chosen[1], is_goal=chosen[2], is_danger=chosen[3], danger_level=chosen[4], item=chosen[5]);
        visit next_loc;
    } elif self.player_choice in ["R", "RIGHT", ">", "2"] {
        self.moves_taken += 1;
        self.path_history.append("RIGHT");
        right_locs = [
            ("â˜€ï¸ Luminous Meadow", "Sunlight streams through.", False, False, 0, ""),
            ("ğŸ’§ Crystal Springs", "Magical water bubbles up.", False, False, 0, "Crystal Water"),
            ("ğŸ» Bear Territory", "A massive bear roars!", False, True, 3, ""),
            ("ğŸŒŠ Rainbow Waterfall", "A magnificent waterfall!", True, False, 0, "Rainbow Pearl"),
            ("ğŸ§š Fairy Court", "The Fairy Queen greets you!", True, False, 0, "Royal Blessing"),
            ("ğŸ¦‹ Butterfly Garden", "Thousands of colorful butterflies!", False, False, 0, "Butterfly Wing"),
            ("ğŸŒº Enchanted Garden", "Flowers sing in harmony.", False, False, 0, "Petal Charm"),
            ("ğŸ‰ Dragon's Peak", "A mighty dragon guards the summit!", False, True, 4, "")
        ];
        
        available_locs = [loc for loc in right_locs if loc[0] not in self.visited_locations];
        if len(available_locs) == 0 {
            available_locs = right_locs;
            self.visited_locations = [];
        }
        
        chosen = random.choice(available_locs);
        self.visited_locations.append(chosen[0]);
        next_loc = here ++> location(name=chosen[0], description=chosen[1], is_goal=chosen[2], is_danger=chosen[3], danger_level=chosen[4], item=chosen[5]);
        visit next_loc;
    } else {
        print("âŒ Invalid choice!");
        visit here;
    }
}

impl ForestExplorer.show_final_results {
    score = (15 - self.moves_taken) * 10 + len(self.items_collected) * 25;
    if self.won {
        score += 150;
    }
    
    print("\n" + "="*60);
    print("ğŸ“Š ADVENTURE SUMMARY");
    print("="*60);
    print(f"ğŸ† Final Score: {score} points");
    print(f"â±ï¸  Moves Taken: {self.moves_taken}");
    print(f"ğŸ’ Items: {len(self.items_collected)}");
    if len(self.items_collected) > 0 {
        print(f"   â””â”€ {', '.join(self.items_collected)}");
    }
    print(f"ğŸ—ºï¸  Path: {' â†’ '.join(self.path_history)}");
    
    if self.won {
        print("\nğŸŒŸ Status: VICTORIOUS!");
    } elif score > 100 {
        print("\nâ­ Status: Great Explorer!");
    } else {
        print("\nâœ¨ Status: Brave Adventurer!");
    }
    
    print("\nğŸ¤– Generating final analysis...\n");
    
    items_str = ', '.join(self.items_collected) if len(self.items_collected) > 0 else "none";
    
    analysis = analyze_performance(self.won, self.moves_taken, items_str, score);
    print(f"ğŸ“ AI ANALYSIS:\n{analysis}\n");
    
    print("="*60);
}